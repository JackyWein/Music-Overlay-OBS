<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Spicetify Debugger</title>
    <style>
        body {
            background: #121212;
            color: white;
            font-family: sans-serif;
            padding: 20px;
        }

        .box {
            background: #1e1e1e;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background: #1DB954;
            border: none;
            font-weight: bold;
            border-radius: 20px;
            color: white;
            margin-right: 10px;
        }

        button:hover {
            brightness: 1.1;
        }

        .log {
            background: #000;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            border: 1px solid #444;
            margin-top: 10px;
            color: #0f0;
        }

        h2 {
            margin-top: 0;
        }

        .status {
            font-weight: bold;
        }

        .success {
            color: #1DB954;
        }

        .error {
            color: #e74c3c;
        }
    </style>
</head>

<body>
    <h1>Spicetify Connection Debugger</h1>

    <div class="box">
        <h2>1. WebNowPlaying (Legacy)</h2>
        <p>Target: <code>ws://localhost:8974/</code></p>
        <button onclick="testConnection('ws', 'localhost', 8974)">Test Connection</button>
        <div id="status-8974" class="status"></div>
    </div>

    <div class="box">
        <h2>2. Spotify Playback API (New)</h2>
        <p>Target: <code>wss://localhost:443/</code> or <code>ws://localhost:443/</code></p>
        <button onclick="testConnection('wss', 'localhost', 443)">Test WSS (Secure)</button>
        <button onclick="testConnection('ws', 'localhost', 443, true)">Test WS (Insecure)</button>
        <div id="status-443" class="status"></div>
    </div>

    <div class="log" id="log"></div>

    <script>
        function log(msg) {
            const el = document.getElementById('log');
            el.innerHTML += `<div>${new Date().toLocaleTimeString()} > ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function testConnection(proto, host, port, isInsecure443 = false) {
            const url = `${proto}://${host}:${port}/`;
            const statusId = port === 8974 ? 'status-8974' : 'status-443';
            const statusEl = document.getElementById(statusId);

            log(`-----------------------------------`);
            log(`Testing connection to: ${url}`);
            statusEl.textContent = 'Connecting...';
            statusEl.className = 'status';

            try {
                const ws = new WebSocket(url);

                ws.onopen = () => {
                    log(`SUCCESS! Connected to ${url}`);
                    statusEl.textContent = '✅ SUCCESS - Server is running!';
                    statusEl.className = 'status success';
                    ws.send('Ping'); // Try to send something
                    setTimeout(() => ws.close(), 1000);
                };

                ws.onmessage = (e) => {
                    log(`RECEIVED DATA: ${e.data}`);
                };

                ws.onerror = (e) => {
                    log(`ERROR: Connection failed.`);
                    console.error(e);
                };

                ws.onclose = (e) => {
                    if (statusEl.className.includes('success')) {
                        log('Connection closed (Expected).');
                    } else {
                        log(`CLOSED: Code ${e.code}. Was it ever open? No.`);
                        statusEl.textContent = '❌ FAILED - Server unreachable / Refused';
                        statusEl.className = 'status error';

                        if (port === 8974) {
                            log('Tip: Run "spicetify config extensions webnowplaying.js" and "spicetify apply"');
                        }
                    }
                };

            } catch (e) {
                log(`CRITICAL ERROR: ${e.message}`);
                statusEl.textContent = '❌ CRITICAL ERROR';
                statusEl.className = 'status error';
            }
        }
    </script>
</body>

</html>